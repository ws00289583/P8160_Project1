---
title: "Evaluating the Impact of Baseline Hazard Function Misspecification on Treatment Effect Estimation"
author: "Charly Fowler, Hanfei Qi, Robert Tumasian III , and Haoyang Yi"
date: "February 24, 2021"
output: pdf_document
---

```{r, include=FALSE}
library(tidyverse)
```

# Objectives

The goal of this study is to evaluate how misspecifying the baseline hazard function can influence the estimation of treatment effects in survival. This work focuses on conducting simulations to compare the exponential and Weibull proportional hazards models to the semi-parameteric Cox proportional hazards model. We also discuss the impact of utilizing an overly complicated model (e.g., Cox) when a less complex model (e.g., exponential) is sufficient.

# Statistical Methods

Survival analysis is used to analyze time-to-event data (e.g., time to symptom onset or time to mortality). Survival functions, $S(t)$, measure the probability of an individual not experiencing an event past a certain time $t$. Similarly, hazard functions, $h(t)$, measure the instantaneous risk of failure at a certain time $t$, given that the individual has not experienced an event until that time. The hazard function can be expressed as $\frac{f(t)}{S(t)}$, where $f(t)$ is the distribution of survival times.\par

One purpose of proportional hazards modeling is to assess the effectiveness of a particular treatment ($X$) over survival time $T$, where the hazard ratio for patient $i$ at time $t$ is defined as $h_i(t)=h_0(t)e^{x_i\beta}$. Here, $h_0(t)$ denotes the pre-specified baseline hazard function, $x_i$ indicates treatment allocation (0=control, 1=treatment), and $\beta$ represents the log hazard ratio, or the hazard reduction among treated individuals compared to the control group. Thus, the proportional hazard can be expressed as $\frac{h(t|x_0)}{h(t|x_1)}=e^{\beta(x_0-x_1)}$, which is independent of survival time $t$.\par

We consider three models: exponential, Weibull, and Cox. The exponential and Weibull models implement different baseline hazard functions, while the Cox model, estimates $\beta$ without this specification. It is important to note that the Exponential model is nested within the Weibull model, as an exponential distribution is a special case of the Weibull distribution where $\gamma = 1$. All models impose the restraint that the effect of the treatment be multiplicative on the hazard curve. The exponential and Weibull hazard curves can be seen below, in Table 1.\par




# Simulation Design

All simulation data was generated using the `simsurv` function in the `simsurv` package. We defined a binomial treatment variable (`trt`) with $p=0.5$ to ensure equal likelihood of random assignment to the treatment or control group.Parameters are set according to different distributions of hazards.The resulting dataset contains time of event(`eventtime`), status(`status`) and treatment(`trt`).

We simulated survival data from six different baseline hazard distributions. First, we simulated from an exponential distribution with $\lambda = 1$, and from a Weibull with $\lambda = 1$, and $\gamma$ values of 0.5, 2, and 5. These values of $\gamma$ were chosen to consider constant, monotone decreasing, linearly increasing, and monotone increasing hazard curves. From these simulations we aim to test the impact of utilizing an overly complex model, such as Cox, when an exponential or Weibull model would suffice. \par

We additionally simulated lognormal data with $\mu = 0$, $\sigma = 0.5$, which generates a non-monotone hazard curve, to understand the implications of mispecifying the underlying distribution when fitting a model. These first five hazard functions we simulated from can be seen in Table 1, below. \par


$$
\begin{array} {lccc}
\hline \text {} & \text { Exponential } & \text { Weibull } & \text { Lognormal } \\
\hline
\text { $h_0(t)$ } & \lambda & \lambda\gamma t^{\gamma-1} & \frac{\frac{1}{t \sigma} \phi(\frac{ln(t)}{\sigma})}{\Phi(\frac{-ln(t)}{\sigma})} \\
\hline
\end{array}
$$

Table 1. Baseline hazard functions, $h_0(t)$, for the continuous models considered in this study. The normal PDF and CDF are denoted by $\phi$ and $\Phi$, respectively.

Lastly, we simulated from a discrete piecewise step function hazard curve, inspired by Brilleman et al. This hazard curve is visualized in Figure 1, below. It was included to further explore the implications of fitting an overly-simplistic model such as exponential or Weibull on data with a complex underlying distribution. \par

```{r, echo= F, warning = F}
#plot hazards: 

set.seed(1729)
ncuts <- 19
cuts <- sort(rexp(ncuts, rate = 0.1))
pw_times <- c(0, cuts)
N <- length(pw_times)
pw_haz <- sort(abs(rnorm(N)))
pw_haz <- abs(pw_haz - median(pw_haz))

haz_piece <- function(t, ...) {
   pw_haz[findInterval(t, pw_times)]
}

haz_log <- function(t) {
  ((1/t*0.5)*dnorm(log(t)/0.5,mean=-0,sd=0.5))/
    (pnorm(-log(t)/0.5,mean=0,sd=0.5))
}

haz_weibull_0.5 = function(t){
  0.5 * t^(0.5-1)
}

haz_exponential = function(t){
  1 * t^(1-1)
}

p <- ggplot(data = data.frame(x = 0), mapping = aes(x = x))

p + 
  stat_function(fun = haz_piece, aes(color = "piece-wise")) + 
  stat_function(fun = haz_log, aes(col = "log-normal")) + 
  stat_function(fun = haz_weibull_0.5, aes(col = "weibull (gamma = 0.5)")) + 
  stat_function(fun = haz_exponential, aes(col = "pink")) + 
  xlim(0,20) + 
  ylim(0,2) + 
  theme_minimal() + 
  scale_color_manual(name = "Hazard Functions", 
                     values = c("red", "green", "blue", "orange"), 
                     labels = c("lognormal", "piece-wise", "exponential", "Weibull (gamma = 0.5)" )) + 
  theme(legend.position="bottom") + 
  labs(x = "t", y = "hazard")
  
```

Figure 1: Baseline hazard functions used to generate data. Note Weibull distribution with $\gamma = 2, 5$ are excluded due to scale.

When simulating the data, we used $\beta = -0.5$ as the true effect size for all underlying distributions. 

We set the sample size as 100 and for each underlying distribution sampled 1000 times to get the dataframe of results. Each time we fitted exponential, Weibull and cox model to the data and extracted the $\beta$ estimates provided by three models.

# Results
* plots should come before simulation results, less complex 

```{r, include=FALSE}
path_to_gamma0.5= "./results_gamma0.5.csv"
path_to_gamma1= "./results_gamma1.csv"
path_to_gamma2= "./results_gamma2.csv"
path_to_gamma5= "./results_gamma5.csv"
path_to_logn= "./results_lognormal.csv"
path_to_piecewise = "./results_piecewise.csv"
result_0.5 = read_csv(file = path_to_gamma0.5)
result_1 = read_csv(file = path_to_gamma1)
result_2 = read_csv(file = path_to_gamma2)
result_5 = read_csv(file = path_to_gamma5)
result_ln = read_csv(file = path_to_logn)
result_pw = read_csv(file = path_to_piecewise) # Load the datasets

mean_beta = tibble(
  Model = c("Exponential", "Weibull", "Cox"),
  Gamma_0.5 = c(mean(result_0.5$exp_beta), mean(result_0.5$weibull_beta), mean(result_0.5$cox_beta)),
  Gamma_1 = c(mean(result_1$exp_beta), mean(result_1$weibull_beta), mean(result_1$cox_beta)),
  Gamma_2 = c(mean(result_2$exp_beta), mean(result_2$weibull_beta), mean(result_2$cox_beta)),
  Gamma_5 = c(mean(result_5$exp_beta), mean(result_5$weibull_beta), mean(result_5$cox_beta)),
  Lognormal = c(mean(result_ln$exp_beta), mean(result_ln$weibull_beta), mean(result_ln$cox_beta)),
  Piecewise = c(mean(result_pw$exp_beta), mean(result_pw$weibull_beta), mean(result_pw$cox_beta))
) %>%
  knitr::kable() # mean of 1000 beta
MSE = function(beta, n=1000) {
  return(sum((-0.5 - beta)^2)/n)
}
```

```{r, echo=FALSE}
MSE_table = tibble(
  Model = c("Exponential", "Weibull", "Cox"),
  Gamma_0.5 = c(MSE(result_0.5$exp_beta), MSE(result_0.5$weibull_beta), MSE(result_0.5$cox_beta)),
  Gamma_1 = c(MSE(result_1$exp_beta), MSE(result_1$weibull_beta), MSE(result_1$cox_beta)),
  Gamma_2 = c(MSE(result_2$exp_beta), MSE(result_2$weibull_beta), MSE(result_2$cox_beta)),
  Gamma_5 = c(MSE(result_5$exp_beta), MSE(result_5$weibull_beta), MSE(result_5$cox_beta)),
  Lognormal = c(MSE(result_ln$exp_beta), MSE(result_ln$weibull_beta), MSE(result_ln$cox_beta)),
  Piecewise = c(MSE(result_pw$exp_beta), MSE(result_pw$weibull_beta), MSE(result_pw$cox_beta))
) %>% # MSE of 1000 beta
  knitr::kable()
MSE_table
```

To assess model performance, we used mean-squared error (MSE) and ____. We also plotted the survival probability versus time of each model, with reference lines.

NOTE: shouldn't the tables be part of results? feel free to change it!  
NOTE2: Values look weird.  
NOTE3: I couldn't find an easy way to plot hazard ratio vs. time, but plot cumulative hazard vs. time is possible.  

\begin{center}

\end{center}

Table #:



# Conclusions

By comparing the Mean square error(MSE) and mean of $\beta$ derived from three models in diffrent simulations, we found that misspecifying the baseline hazard function can lead to significant differences between actual value of $\beta$ and the truth(which was set as -0.5). For example, we got high MSEs and biased means of $\beta$ when applying exponential and Weibull model in data simulated by gamma distributions, which indicates that the treatment effect was not evaluated well. In this case, Cox model provide small MSEs, while means of $\beta$ are quite close to the truth. Thus we conclude that Cox model can estimate the treatment effect with high accuracy and precision which avoids the impacts of misspecifying the baseline hazard function.

Case of the impact of fitting too complicated a model when an exponential is sufficient_____________

# Contributions

Charly Fowler worked on simulation functions, performed piecewise simulation, plotted baseline hazard curves, and created datasets of results.
Hanfei Qi worked on creating the format of simulation functions and editing plotting functions.
Robert Tumasian III worked on editing simulation functions, perform lognormal simulation and creating datasets of results.
Haoyang Yi worked on creating plotting functions and editing simulation functions.

# References 

https://www.jstatsoft.org/article/view/v097i03 ___ need to cite properly