---
title: "visualization"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(survival)
library(quantreg)
library(glmnet)
library(MASS)
library(pROC)
library(simsurv)
library(flexsurv)
library(tidyverse)
library(broom)
knitr::opts_chunk$set(echo = TRUE)
```

Visualization: survival probability vs. time 
```{r}
################# Generate Exp or Weib dist data ###################
cov <- data.frame(id = 1:500,
                    trt = rbinom(500, 1, 0.5))
  
# Simulate the event times
dat <- simsurv(lambdas = 0.1, 
               gammas = 1, #change gamma,or use lognormal simulation
               betas = c(trt = -0.5), 
               x = cov)
dat <- merge(cov, dat)


################### Generate lognormal dist data ###################
# log-norm hazard fn
haz <- function(t, x, betas, mu, sigma) {
  exp(betas * (x)) * ((1/t*sigma)*dnorm(log(t)/sigma,mean=mu,sd=sigma))/
    (pnorm(-log(t)/sigma,mean=mu,sd=sigma))
}
# sim log-norm data
cov <- data.frame(trt = rbinom(100, 1, 0.5))
dat <- cbind(simsurv(hazard = haz, 
                 x = cov,
                 mu = 0, 
                 sigma = 0.5,
                 betas = c(trt = -0.5)), 
                 cov)
  

################### Generate piece-wise dist data ###################
set.seed(1729)
ncuts <- 19
cuts <- sort(rexp(ncuts, rate = 0.1))
pw_times <- c(0, cuts)
N <- length(pw_times)
pw_haz <- sort(abs(rnorm(N)))
pw_haz <- abs(pw_haz - median(pw_haz))

haz <- function(t, x, betas, lb_interval, haz_interval, ...) {
  exp(betas * (x)) * haz_interval[findInterval(t, lb_interval)]
}

cov <- data.frame(trt = rbinom(100, 1, 0.5))
dat <- cbind(simsurv(hazard = haz, 
                 x = cov,
                 lb_interval = pw_times, 
                 haz_interval = pw_haz, 
                 betas = c(trt = -0.5)), 
               cov)

# Merge the simulated event times onto covariate data frame
# No parameters need to be changed
s <- with(dat,Surv(eventtime,status))
sWei <- survreg(s ~ as.factor(trt),dist='weibull',data=dat)
sExp <- survreg(s ~ as.factor(trt),dist='exp',data=dat)
sCox <- coxph(s ~ trt,data=dat)
```

```{r}
s <- with(dat,Surv(eventtime,status))
fKM <- survfit(s ~ trt,data=dat) # fit the data using survfit() method in black line as reference.
baseline <- basehaz(sCox)
par(mfrow=c(2,2))
    plot(fKM,main = 'cox')
    lines(survfit(sCox,newdata=data.frame(trt=1),conf.int = F),col='green')
    lines(survfit(sCox,newdata=data.frame(trt=0),conf.int = F),col='green')
    plot(fKM,main = 'weibull')
    lines(predict(sWei, newdata=list(trt=0),type="quantile",p=seq(.01,.99,by=.01)),seq(.99,.01,by=-.01),col="red")
    lines(predict(sWei, newdata=list(trt=1),type="quantile",p=seq(.01,.99,by=.01)),seq(.99,.01,by=-.01),col="red")
    plot(fKM,main = 'exponential')
    lines(predict(sExp, newdata=list(trt=0),type="quantile",p=seq(.01,.99,by=.01)),seq(.99,.01,by=-.01),col="blue")
    lines(predict(sExp, newdata=list(trt=1),type="quantile",p=seq(.01,.99,by=.01)),seq(.99,.01,by=-.01),col="blue")
    plot(baseline$time, baseline$hazard, type='l',main="Hazard rates", xlab = "Time", ylab = "Hazard") 
    lines(baseline$time, exp(sCox$coefficients[1])*baseline$hazard, col="blue")
```



```{r}
#plot hazards: 

set.seed(1729)
ncuts <- 19
cuts <- sort(rexp(ncuts, rate = 0.1))
pw_times <- c(0, cuts)
N <- length(pw_times)
pw_haz <- sort(abs(rnorm(N)))
pw_haz <- abs(pw_haz - median(pw_haz))

haz_piece <- function(t, ...) {
   pw_haz[findInterval(t, pw_times)]
}

haz_log <- function(t) {
  ((1/t*0.5)*dnorm(log(t)/0.5,mean=-0,sd=0.5))/
    (pnorm(-log(t)/0.5,mean=0,sd=0.5))
}

haz_weibull_0.5 = function(t){
  0.5 * t^(0.5-1)
}




p <- ggplot(data = data.frame(x = 0), mapping = aes(x = x))

p + 
  stat_function(fun = haz_piece, aes(color = "piece-wise")) + 
  stat_function(fun = haz_log, aes(col = "log-normal")) + 
  stat_function(fun = haz_weibull_0.5, aes(col = "weibull (gamma = 0.5)")) + 
  stat_function(fun = haz_exponential, aes(col = "pink")) + 
  xlim(0,20) + 
  ylim(0,2) + 
  theme_bw() + 
  scale_color_manual(name = "Hazard Functions", 
                     values = c("red", "green", "blue", "orange"), 
                     labels = c("log-normal", "piece-wise", "exponential", "weibull (gamma = 0.5)" )) + 
  theme(legend.position="bottom") + 
  labs(x = "t", y = "hazard")
  
```

